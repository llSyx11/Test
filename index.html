<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Environment</title>
    <style>
        * { margin: 0; padding: 0; }
        canvas { display: block; }
        #joystick-container, #right-joystick { 
            position: fixed; 
            bottom: 20px;
            width: 100px;
            height: 100px;
            z-index: 100;
            display: none;
        }
        #joystick-container { left: 20px; }
        #right-joystick { right: 20px; }
        .keyboard-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            color: white;
            font-family: Arial;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            display: none;
        }
        #collisionToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            z-index: 1000;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: Arial;
            z-index: 1000;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #retry-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #3498db;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loader"></div>
        <div id="loading-text">Загрузка 0%</div>
        <button id="retry-button">Повторить попытку</button>
    </div>
    <div class="keyboard-controls">W A S D + Mouse</div>
    <button id="collisionToggle">Show Collisions</button>
    <div id="joystick-container"></div>
    <div id="right-joystick"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

    <script>
        const MAX_RETRIES = 10;
        const RETRY_INTERVAL = 60000;
        let retryCount = 0;
        let currentController = null;
        let currentTimeout = null;

        const PLAYER_HEIGHT = 0.5;
        const CAMERA_HEIGHT = 1.6;
        const CAPSULE_RADIUS = 0.03;
        const GRAVITY_FORCE = 5;
        const JUMP_FORCE = 600;
        const COLLISION_DISTANCE = 0.01;

        let scene, camera, renderer, model;
        let isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        let moveSpeed = 0.8;
        let rotateSpeed = 0.002;
        let clock = new THREE.Clock();
        let yaw = 0;
        let pitch = 0;
        let isLocked = false;
        let velocity = new THREE.Vector3();
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let canJump = true;
        let collisionObjects = [];
        const raycaster = new THREE.Raycaster();
        let showCollisions = false;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, CAMERA_HEIGHT, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            
            const directional = new THREE.DirectionalLight(0xffffff, 0.8);
            directional.position.set(5, 5, 5);
            scene.add(directional);

            createCollisionEnvironment();
            createSky();
            createTrees();

            const retryButton = document.getElementById('retry-button');
            retryButton.addEventListener('click', startLoading);
            
            startLoading();

            document.getElementById('collisionToggle').addEventListener('click', () => {
                showCollisions = !showCollisions;
                collisionObjects.forEach(obj => obj.material.visible = showCollisions);
                document.getElementById('collisionToggle').textContent = 
                    showCollisions ? "Hide Collisions" : "Show Collisions";
            });

            if (isMobile) setupMobileControls();
            else setupDesktopControls();

            window.addEventListener('resize', onWindowResize);
        }

        function startLoading() {
            retryCount = 0;
            document.getElementById('retry-button').style.display = 'none';
            loadModelWithRetry();
        }

        function loadModelWithRetry() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const retryButton = document.getElementById('retry-button');

            if (currentController) currentController.abort();
            if (currentTimeout) clearTimeout(currentTimeout);

            currentController = new AbortController();
            currentTimeout = setTimeout(() => {
                currentController.abort();
                handleError(new Error('Timeout error'), loadingText, retryButton);
            }, 60000);

            loadingText.textContent = `Попытка ${retryCount + 1}/${MAX_RETRIES}...`;

            fetch('001.glb', { signal: currentController.signal })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const reader = response.body.getReader();
                    const contentLength = +response.headers.get('Content-Length');
                    let receivedLength = 0;
                    const chunks = [];
                    
                    return new Promise((resolve, reject) => {
                        function pump() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    resolve(new Blob(chunks));
                                    return;
                                }
                                
                                chunks.push(value);
                                receivedLength += value.length;
                                const percent = Math.round((receivedLength / contentLength) * 100);
                                loadingText.textContent = `Загрузка ${percent}%`;
                                pump();
                            }).catch(reject);
                        }
                        pump();
                    });
                })
                .then(blob => {
                    clearTimeout(currentTimeout);
                    const loader = new THREE.GLTFLoader();
                    loader.parse(blob.arrayBuffer(), '', gltf => {
                        model = gltf.scene;
                        model.scale.set(1, 1, 1);
                        model.position.set(0, 0, -5);
                        
                        model.traverse(child => {
                            if (child.isMesh && child.name.startsWith('collision_')) {
                                child.material = new THREE.MeshStandardMaterial({
                                    color: 0xff0000,
                                    side: THREE.DoubleSide,
                                    visible: showCollisions
                                });
                                collisionObjects.push(child);
                            }
                        });
                        
                        scene.add(model);
                        document.getElementById('loading-overlay').style.display = 'none';
                    }, error => {
                        handleError(error, loadingText, retryButton);
                    });
                })
                .catch(error => {
                    handleError(error, loadingText, retryButton);
                });
        }

        function handleError(error, loadingText, retryButton) {
            console.error('Error:', error);
            clearTimeout(currentTimeout);
            
            if (retryCount < MAX_RETRIES - 1) {
                retryCount++;
                loadingText.textContent = `Повторная попытка ${retryCount}/${MAX_RETRIES} через 60 сек...`;
                setTimeout(() => loadModelWithRetry(), RETRY_INTERVAL);
            } else {
                loadingText.textContent = 'Ошибка загрузки модели';
                retryButton.style.display = 'block';
            }
        }

        // Остальные функции (createCollisionEnvironment, createSky, createTrees, checkCollision, 
        // setupDesktopControls, setupMobileControls, animate и т.д.) остаются без изменений
        // ... [остальной код без изменений] ...
    </script>
</body>
</html>
